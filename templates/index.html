<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Analyzer + AutoRepair</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e2e8f0; }
  .font-mono { font-family: 'Fira Code', monospace; }
  .custom-scroll::-webkit-scrollbar { width: 6px; }
  .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
</style>
</head>
<body class="min-h-screen flex flex-col">

<nav class="bg-[#0d111c] px-6 py-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
    <h1 class="text-xl font-bold text-white">Python <span class="text-indigo-400">Analyzer</span></h1>
    <button id="btnAnalizar" onclick="analizarCodigo()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded font-bold">Analizar</button>
</nav>

<main class="container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Editor de código -->
    <div class="flex-1">
        <label class="block mb-2 text-sm font-semibold">Código Python:</label>
        <textarea id="codigo" class="w-full h-[400px] p-4 font-mono text-sm bg-[#111827] border border-slate-700 rounded-lg custom-scroll" placeholder="Pega tu código aquí..."></textarea>
    </div>

    <!-- Panel de reportes y código corregido -->
    <div class="flex-1 flex flex-col gap-4">
        <div class="bg-[#111827] p-4 rounded-lg border border-slate-700 h-[200px] overflow-y-auto custom-scroll">
            <h2 class="text-sm font-bold mb-2">Reporte de errores:</h2>
            <div id="reportPanel" class="text-xs"></div>
        </div>

        <div class="bg-[#111827] p-4 rounded-lg border border-slate-700 flex flex-col">
            <h2 class="text-sm font-bold mb-2">Código corregido:</h2>
            <textarea id="codigoCorregido" class="w-full h-[180px] p-2 font-mono text-xs bg-[#0f172a] rounded custom-scroll" readonly></textarea>
            <div class="mt-2 flex gap-2">
                <button onclick="copiarCodigo()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-1 rounded text-white text-sm font-bold">Copiar</button>
                <button onclick="descargarCodigo()" class="bg-blue-600 hover:bg-blue-500 px-4 py-1 rounded text-white text-sm font-bold">Descargar</button>
            </div>
        </div>
    </div>
</main>

<script>
async function analizarCodigo() {
    const codigo = document.getElementById("codigo").value;
    const reportPanel = document.getElementById("reportPanel");
    const codigoCorregido = document.getElementById("codigoCorregido");

    reportPanel.innerHTML = "<p class='text-gray-400'>Analizando...</p>";
    codigoCorregido.value = "";

    try {
        const response = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code: codigo })
        });

        const data = await response.json();

        // Mostrar reporte
        if (data.report.length === 0) {
            reportPanel.innerHTML = "<p class='text-green-400'>No se encontraron errores</p>";
        } else {
            reportPanel.innerHTML = data.report.map(r => {
                let color = r.tipo === "critico" ? "text-red-400" :
                            r.tipo === "warning" ? "text-yellow-400" : "text-green-400";
                return `<div class='mb-1 ${color}'>Línea ${r.linea || "-"}: ${r.mensaje}</div>`;
            }).join("");
        }

        // Mostrar código corregido
        codigoCorregido.value = data.fixed_code;

    } catch (err) {
        reportPanel.innerHTML = "<p class='text-red-500'>Error al analizar el código.</p>";
        console.error(err);
    }
}

function copiarCodigo() {
    const codigoCorregido = document.getElementById("codigoCorregido");
    codigoCorregido.select();
    document.execCommand("copy");
    alert("Código corregido copiado al portapapeles");
}

async function descargarCodigo() {
    const codigoCorregido = document.getElementById("codigoCorregido").value;
    const response = await fetch("/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: codigoCorregido })
    });

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "codigo_reparado.py";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
}
</script>

</body>
</html>
