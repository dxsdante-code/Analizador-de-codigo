<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Código Python</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        textarea, pre {
            width: 100%;
            box-sizing: border-box;
            font-family: monospace;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: #fff;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            opacity: 0.9;
        }
        .btn-analyze { background-color: #4CAF50; color: white; }
        .btn-copy { background-color: #2196F3; color: white; }
        .btn-download { background-color: #f44336; color: white; }
        .section {
            margin-bottom: 20px;
        }
        .report-line {
            margin-bottom: 5px;
        }
        .report-line.ok { color: green; }
        .report-line.warning { color: orange; }
        .report-line.critico { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Analizador y Corrector de Código Python</h1>

    <div class="section">
        <label for="codeInput">Código Python:</label>
        <textarea id="codeInput" rows="12" placeholder="Pega aquí tu código Python..."></textarea>
        <button class="btn-analyze" onclick="analizarCodigo()">Analizar</button>
    </div>

    <div class="section">
        <label>Errores y Reportes:</label>
        <pre id="reportOutput">Aquí aparecerán los errores y advertencias...</pre>
    </div>

    <div class="section">
        <label>Código Corregido:</label>
        <textarea id="fixedCode" rows="12" readonly></textarea>
        <button class="btn-copy" onclick="copiarCodigo()">Copiar Código</button>
        <button class="btn-download" onclick="descargarCodigo()">Descargar</button>
    </div>

    <div class="section">
        <label>Análisis Semántico (IA):</label>
        <pre id="semanticOutput">Aquí aparecerá la explicación semántica del código...</pre>
    </div>

    <script>
        async function analizarCodigo() {
            const code = document.getElementById('codeInput').value;

            // Limpiar campos antes de análisis
            document.getElementById('reportOutput').textContent = 'Analizando...';
            document.getElementById('fixedCode').value = '';
            document.getElementById('semanticOutput').textContent = 'Consultando IA...';

            try {
                // Llamada al endpoint de análisis de errores y autorepair
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();

                // Mostrar reportes
                let reportText = '';
                data.report.forEach(r => {
                    reportText += `[${r.tipo}] Línea ${r.linea || '-'}: ${r.mensaje}\n`;
                });
                document.getElementById('reportOutput').textContent = reportText;

                // Mostrar código corregido
                document.getElementById('fixedCode').value = data.fixed_code || '';

                // Llamada al endpoint semántico IA
                const semanticResp = await fetch('/semantic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const semanticData = await semanticResp.json();
                document.getElementById('semanticOutput').textContent = semanticData.semantica || 'IA no disponible';
            } catch (err) {
                document.getElementById('reportOutput').textContent = 'Error al analizar el código: ' + err;
                document.getElementById('semanticOutput').textContent = '';
            }
        }

        function copiarCodigo() {
            const fixedCode = document.getElementById('fixedCode');
            fixedCode.select();
            fixedCode.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('Código copiado al portapapeles');
        }

        function descargarCodigo() {
            const code = document.getElementById('fixedCode').value;
            const blob = new Blob([code], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'codigo_corregido.py';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
