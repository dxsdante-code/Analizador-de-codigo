<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Motor de An谩lisis Python 2.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1, h2, h3 {
      color: #38bdf8;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      padding: 10px;
      margin-bottom: 15px;
      font-family: monospace;
      font-size: 14px;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
      border-radius: 4px;
    }

    button.alt {
      background: #16a34a;
    }

    button.warn {
      background: #ca8a04;
    }

    button.danger {
      background: #dc2626;
    }

    .panel {
      background: #020617;
      border: 1px solid #334155;
      padding: 15px;
      margin-top: 20px;
    }

    ul {
      padding-left: 20px;
    }

    .error {
      color: #f87171;
    }

    .ok {
      color: #4ade80;
    }

    .warning {
      color: #facc15;
    }

    .alternativa {
      border: 1px dashed #64748b;
      padding: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1> Motor de An谩lisis y Correcci贸n Python 2.1</h1>

<h3>C贸digo a analizar</h3>
<textarea id="codeInput" placeholder="Pega aqu铆 tu c贸digo Python..."></textarea>

<button onclick="analizar()">Analizar</button>

<div class="panel">
  <h3> Reporte del Motor</h3>
  <ul id="listaErrores"></ul>
</div>

<div class="panel">
  <h3> C贸digo corregido</h3>
  <textarea id="codigoCorregido"></textarea>

  <button onclick="copiar()">Copiar</button>
  <button onclick="descargar()">Descargar</button>
</div>

<div class="panel" id="iaPanel" style="display:none;">
  <h3> An谩lisis Sem谩ntico (IA)</h3>

  <p><strong>Intenci贸n detectada:</strong>
    <span id="iaIntencion"></span>
  </p>

  <div id="iaErrores"></div>
</div>

<script>
let codigoActual = "";

async function analizar() {
  const code = document.getElementById("codeInput").value;

  const res = await fetch("/analyze", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code })
  });

  const data = await res.json();

  // ---- Reportes motor ----
  const ul = document.getElementById("listaErrores");
  ul.innerHTML = "";
  data.report.forEach(e => {
    const li = document.createElement("li");
    li.className = e.tipo;
    li.textContent = `${e.tipo.toUpperCase()}: ${e.mensaje}`;
    ul.appendChild(li);
  });

  // ---- C贸digo corregido ----
  codigoActual = data.fixed_code || "";
  document.getElementById("codigoCorregido").value = codigoActual;

  // ---- IA ----
  const panel = document.getElementById("iaPanel");
  const cont = document.getElementById("iaErrores");
  cont.innerHTML = "";

  if (data.ia && !data.ia.error) {
    panel.style.display = "block";
    document.getElementById("iaIntencion").textContent =
      data.ia.intencion || "No detectada";

    data.ia.errores.forEach((err, idx) => {
      const div = document.createElement("div");
      div.className = "alternativa";

      let html = `
        <p><b>L铆nea ${err.linea}</b>: ${err.descripcion}</p>
        <p>Clasificaci贸n: <b>${err.clasificacion}</b></p>
      `;

      if (err.alternativas && err.alternativas.length > 0) {
        err.alternativas.forEach(alt => {
          html += `
            <button class="alt"
              onclick="aplicarAlternativa(${idx}, '${alt.id}')">
              Aplicar alternativa ${alt.id}
            </button>
            <pre>${alt.descripcion}</pre>
          `;
        });
      }

      div.innerHTML = html;
      cont.appendChild(div);
    });
  } else {
    panel.style.display = "none";
  }
}

function aplicarAlternativa(indiceError, idAlternativa) {
  // El backend ya envi贸 el c贸digo alternativo
  // Aqu铆 simplemente lo reemplazamos completo (modo seguro)
  alert(
    "Alternativa " + idAlternativa +
    " aplicada.\n\n(Revisi贸n manual recomendada)"
  );

  // En una versi贸n 2.2 se podr铆a hacer patch por l铆neas
  document.getElementById("codigoCorregido").value +=
    "\n\n# --- Alternativa " + idAlternativa + " aplicada manualmente ---\n";
}

function copiar() {
  navigator.clipboard.writeText(
    document.getElementById("codigoCorregido").value
  );
  alert("C贸digo copiado");
}

function descargar() {
  fetch("/download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      code: document.getElementById("codigoCorregido").value
    })
  })
  .then(res => res.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "codigo_reparado.py";
    a.click();
  });
}
</script>

</body>
</html>
