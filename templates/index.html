<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeFixer Pro | AI Refactor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e5e7eb; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="bg-[#0d111c] border-b border-slate-800 px-6 py-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Code<span class="text-indigo-400">Fixer</span></h1>
            <button id="btnAnalizar" onclick="analizarCodigo()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-xl font-bold flex items-center gap-2">
                Analizar
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Editor de código -->
        <div class="lg:col-span-6">
            <label class="text-xs font-bold uppercase mb-2">Código a analizar</label>
            <textarea id="codeEditor" class="w-full h-[500px] p-4 font-mono text-sm bg-[#111827] rounded-xl custom-scroll focus:outline-none" placeholder="# Pega tu código aquí..."></textarea>
        </div>

        <!-- Panel de reportes y código corregido -->
        <div class="lg:col-span-6 space-y-4">
            
            <div>
                <label class="text-xs font-bold uppercase mb-2">Reporte de errores / sugerencias</label>
                <div id="reportPanel" class="h-[250px] p-4 bg-[#111827] rounded-xl overflow-y-auto custom-scroll text-xs text-slate-300">
                    Aquí aparecerán los errores y sugerencias.
                </div>
            </div>

            <div>
                <label class="text-xs font-bold uppercase mb-2">Código corregido</label>
                <textarea id="fixedCode" class="w-full h-[200px] p-4 font-mono text-sm bg-[#111827] rounded-xl custom-scroll focus:outline-none" readonly></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="copiarCodigo()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-xl font-bold text-white">Copiar</button>
                    <button onclick="descargarCodigo()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-xl font-bold text-white">Descargar</button>
                </div>
            </div>

        </div>

    </main>

    <script>
        let fixed_code_global = "";

        async function analizarCodigo() {
            const code = document.getElementById("codeEditor").value;
            const reportPanel = document.getElementById("reportPanel");
            const fixedCodeArea = document.getElementById("fixedCode");

            reportPanel.innerHTML = "Analizando...";
            fixedCodeArea.value = "";

            try {
                const response = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code: code })
                });
                const data = await response.json();

                fixed_code_global = data.fixed_code || "";
                fixedCodeArea.value = fixed_code_global;

                // Mostrar reporte
                if (data.report.length === 0) {
                    reportPanel.innerHTML = "<p class='text-green-400'>No se encontraron errores.</p>";
                } else {
                    reportPanel.innerHTML = "";
                    data.report.forEach(r => {
                        const color = r.tipo === "critico" ? "text-red-500" :
                                      r.tipo === "warning" ? "text-yellow-400" :
                                      "text-green-400";
                        reportPanel.innerHTML += `<div class="mb-1 ${color}">[${r.tipo}] Línea ${r.linea || '-'}: ${r.mensaje}</div>`;
                    });
                }
            } catch (error) {
                reportPanel.innerHTML = `<p class="text-red-500">Error: ${error}</p>`;
            }
        }

        function copiarCodigo() {
            if (!fixed_code_global) return;
            navigator.clipboard.writeText(fixed_code_global);
            alert("Código copiado al portapapeles");
        }

        async function descargarCodigo() {
            if (!fixed_code_global) return;
            const response = await fetch("/download", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code: fixed_code_global })
            });
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "codigo_reparado.py";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        }
    </script>

</body>
</html>
