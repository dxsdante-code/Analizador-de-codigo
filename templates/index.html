<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeFixer Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');
        .font-mono { font-family: 'Fira Code', monospace; }
        body { background-color: #080a11; color: #cbd5e1; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <nav class="flex justify-between items-center mb-8 border-b border-white/5 pb-4">
        <h1 class="text-xl font-bold text-white"><i class="fas fa-microchip text-blue-500 mr-2"></i>CodeFixer</h1>
        <div class="flex gap-2">
            <button onclick="analizarCodigo()" id="btnAnalizar" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                <i class="fas fa-play"></i> Analizar
            </button>
            <form action="/descargar" method="POST" id="formDescarga">
                <input type="hidden" name="code" id="hiddenCode">
                <button type="submit" id="btnDescargar" class="hidden bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                    <i class="fas fa-download"></i> Descargar .py
                </button>
            </form>
        </div>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
        <div class="lg:col-span-8 bg-[#0d1117] rounded-xl border border-white/5 overflow-hidden flex flex-col">
            <textarea id="codeEditor" class="w-full flex-grow bg-transparent p-6 font-mono text-sm text-blue-100 focus:outline-none resize-none" placeholder="# Pega tu código aquí..."></textarea>
        </div>

        <div class="lg:col-span-4 bg-[#0d1117] rounded-xl border border-white/5 p-6 space-y-4">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                <i class="fas fa-list text-blue-500"></i> Reporte
            </h2>
            <div id="resultsPanel" class="space-y-4 overflow-y-auto max-h-[500px]">
                <p class="text-[10px] text-slate-600 italic">Listo para procesar...</p>
            </div>
            <button id="btnAplicar" onclick="aplicarMejoras()" class="hidden w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all">
                Aplicar Corrección
            </button>
        </div>
    </div>

    <script>
        let codigoCorregido = "";

        async function analizarCodigo() {
            const code = document.getElementById('codeEditor').value;
            const panel = document.getElementById('resultsPanel');
            const btn = document.getElementById('btnAnalizar');

            if (!code.trim()) return;

            btn.disabled = true;
            panel.innerHTML = '<div class="flex justify-center py-10"><i class="fas fa-sync fa-spin text-blue-500"></i></div>';

            try {
                const response = await fetch('/analizar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();
                codigoCorregido = data.codigo_corregido;
                panel.innerHTML = '';

                if (data.cambios_realizados > 0) {
                    document.getElementById('btnAplicar').classList.remove('hidden');
                    document.getElementById('btnDescargar').classList.remove('hidden');
                    document.getElementById('hiddenCode').value = data.codigo_corregido;
                }

                data.hallazgos.forEach(res => {
                    panel.innerHTML += `
                        <div class="p-3 bg-blue-500/5 border-l-4 border-blue-500 rounded text-[12px]">
                            <p class="font-bold text-blue-400 uppercase">${res.codigo}</p>
                            <p class="text-slate-300 mt-1">${res.mensaje}</p>
                        </div>`;
                });
            } catch (e) {
                panel.innerHTML = '<p class="text-red-500 text-xs uppercase">Error de servidor</p>';
            } finally {
                btn.disabled = false;
            }
        }

        function aplicarMejoras() {
            document.getElementById('codeEditor').value = codigoCorregido;
            document.getElementById('btnAplicar').classList.add('hidden');
            analizarCodigo();
        }
    </script>
</body>
</html>
